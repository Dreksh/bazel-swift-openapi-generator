GreetingService
===============

This is based on the [tutorial for using the server stubs using the swift-openapi-generator](https://swiftpackageindex.com/apple/swift-openapi-generator/0.3.5/tutorials/swift-openapi-generator/serverswiftpm
)

Running the Code:
-----------------

The code can be built and run by:
```shell
bazel run //Sources
```

For this example, it will launch a server that greets people. Interact with it via curl.
```shell
% curl 'localhost:8080/api/greet?name=Jane'
{
  "message" : "Hello, Jane"
}
```

Components:
-----------

The code within this workspace can be split for different purposes.

### Source Code

The source code is from the tutorial linked above. It's a mixture of running
`swift package init` and the files written in the tutorial.

Files:
- Package.swift
- .gitignore
- Sources/main.swift
- Sources/openapi.yaml
- Sources/openapi-generator-config.yaml

With just these files, the server can be launched by building and running via
the `swift` commands.

### Bazel with Swift Package Manager (SPM)

This uses the bazel module [rules\_swift\_package\_manager](https://github.com/cgrindel/rules_swift_package_manager). It allows for defining the dependencies
in BUILD.bazel files via gazelle extensions.

Files:
- .bazelrc
- WORKSPACE
- MODULE.bazel
- \*\*/BUILD.bazel  (autogenerated)

The files in the root of the WORKSPACE are copied from [`//internal/*`](../../internal) of this git repo.
The autogenerated `BUILD.bazel` files are created by running:
```shell
bazel run //:update_deps_to_latest
bazel run //:create_build_files
```

At this point, the code will not compile. This is because the `Package.swift` code generation
isn't run when compiling.

### Bazel with SPM with swift-openapi-generator

Add an explicit rule for generating the Swift code. This requires making changes in
`MODULE.bazel` and `Sources/BUILD.bazel`.

`MODULE.bazel` is to add a dependency on swift-openapi-generator:
```python
# Adding the swift-openapi-generator
# (this will need to be replaced by a module_extension if it's not included in a bazel registry yet)
bazel_dep(name = "swift-openapi-generator")
local_path_override(module_name = "swift-openapi-generator", path = "../../")
```

`Sources/BUILD.bazel` is to create the generated Swift code:
```python
load("@swift-openapi-generator//:defs.bzl", "swift_openapi_generate")

swift_openapi_generate(
    name = "server_stub",
    spec = "openapi.yaml",
    config = "openapi-generator-config.yaml",
) 
```

We also need to add it as a dependency of the swift\_binary rule in the same file.
Notice that there is a `#keep` next to the entry, and that's a marker for gazelle to keep the generated code
as part of the source.
```python
swift_binary(
    ...
    srcs = [
        ...
        "server_stub", #keep
    ],  
    ...
)
```

The generated code by default uses the package-scope as the access modifier. This requires swift knowing the package name.
There are two way around this:
1. Add the package\_name into the swift\_binary rule
```skylark
swift_binary(
    ...
    package_name = "some_value_here", #keep
)
```
2. Make the generated code have a different access modifier (specified in openapi-generator-config.yaml)
```yaml
...
accessModifier: internal
```

